{% extends "base.html" %}
{% load static %}

{% block contents %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Quản lý xe ra vào</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="{% static 'app/css/vehicle_management.css' %}" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />
  </head>

  <body>
    <main class="container mx-auto p-4 sm:p-6 max-w-6xl mt-20">
      <header class="text-center mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Danh sách xe trong hệ thống</h1>
      </header>

      <!-- Tìm kiếm -->
      <div class="mb-6 flex justify-center">
        <input
          type="text"
          id="searchInput"
          class="border border-gray-300 rounded-xl p-2 w-full max-w-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
          placeholder="Tìm kiếm theo biển số, loại xe, chủ xe..."
          onkeyup="searchVehicle()"
        />
      </div>

      <!-- Danh sách xe -->
      <div class="bg-white p-6 rounded-2xl shadow-lg">
        <h2 class="text-2xl font-semibold mb-4">Danh sách xe đã quét</h2>
        <div class="overflow-auto">
          <table class="table-auto w-full text-sm" id="vehicleTable">
            <thead class="bg-gray-200">
              <tr>
                <th class="px-4 py-2 text-left">Biển số</th>
                <th class="px-4 py-2 text-left">Loại xe</th>
                <th class="px-4 py-2 text-left">Chủ xe</th>
                <th class="px-4 py-2 text-left">Vị trí</th>
                <th class="px-4 py-2 text-left">Lượt vào/ra</th>
                <th class="px-4 py-2 text-left">Thời gian</th>
                <th class="px-4 py-2 text-left">Tổng tiền</th>
                <th class="px-4 py-2 text-left">Hành động</th>
              </tr>
            </thead>
            <tbody>
              {% for item in vehicles %}
                <tr class="border-b">
                  <td class="px-4 py-2">{{ item.vehicle.bienso }}</td>
                  <td class="px-4 py-2">{{ item.vehicle.loaixe }}</td>
                  <td class="px-4 py-2">
                    {% if item.vehicle.makh %}
                      {{ item.vehicle.makh.ten }}
                    {% else %}
                      Chưa có chủ xe
                    {% endif %}
                  </td>
                  <td class="px-4 py-2">
                    {{ item.ten_vitri }}
                  </td>
                  <td class="px-4 py-2">
                    {% for luot in item.vehicle.luotravao_set.all %}
                      <div class="mb-1">
                        {{ luot.thoigianvao }} - {{ luot.thoigianra }}
                      </div>
                    {% endfor %}
                  </td>
                  <td class="px-4 py-2">
                    {% for luot in item.vehicle.luotravao_set.all %}
                      <div class="mb-1">
                        Vào: {{ luot.thoigianvao }}<br />
                        Ra: {{ luot.thoigianra }}
                      </div>
                    {% endfor %}
                  </td>
                  <td class="px-4 py-2">
                    {% for luot in item.vehicle.luotravao_set.all %}
                      <div class="mb-1">
                        {{ luot.trangthai }} - Tổng tiền: {{ luot.tongtien }} VND
                      </div>
                    {% endfor %}
                  </td>
                  <td class="px-4 py-2">
                    <a href="{% url 'vehicle_edit' item.vehicle.bienso %}" class="text-blue-500">Sửa</a> |
                    <a href="{% url 'vehicle_delete' item.vehicle.bienso %}" class="text-red-500">Xóa</a>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="8" class="text-center py-2">Không có xe nào trong hệ thống</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Script tìm kiếm -->
    <script>
      function searchVehicle() {
        const input = document.getElementById("searchInput").value.toLowerCase();
        const table = document.getElementById("vehicleTable");
        const trs = table.getElementsByTagName("tr");

        for (let i = 1; i < trs.length; i++) { // bỏ header
          const tds = trs[i].getElementsByTagName("td");
          let found = false;
          for (let j = 0; j < tds.length - 1; j++) { // trừ cột Hành động
            if (tds[j] && tds[j].textContent.toLowerCase().includes(input)) {
              found = true;
              break;
            }
          }
          trs[i].style.display = found ? "" : "none";
        }
      }
    </script>

  </body>
</html>
{% endblock contents %}
