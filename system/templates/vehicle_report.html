{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% load humanize %}

{% block contents %}
<div class="max-w-7xl mx-auto py-8 px-2">
  <h1 class="text-4xl font-extrabold text-center text-blue-800 mb-8 drop-shadow">Báo cáo & Thống kê giữ xe</h1>
  
  <!-- Bộ lọc -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8 flex flex-col md:flex-row gap-4 items-center justify-between">
    <form method="GET" action="{% url 'vehicle_report' %}" class="flex flex-col md:flex-row gap-4 w-full">
      <div>
        <label for="fromDate" class="block text-sm font-semibold text-gray-700">Từ ngày</label>
        <input type="date" id="fromDate" name="from_date" value="{{ from_date|date:'Y-m-d' }}" class="border border-gray-300 rounded-lg p-2 w-full mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none">
      </div>
      <div>
        <label for="toDate" class="block text-sm font-semibold text-gray-700">Đến ngày</label>
        <input type="date" id="toDate" name="to_date" value="{{ to_date|date:'Y-m-d' }}" class="border border-gray-300 rounded-lg p-2 w-full mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none">
      </div>
      <div>
        <label for="vehicleType" class="block text-sm font-semibold text-gray-700">Loại xe</label>
        <select id="vehicleType" name="vehicle_type" class="border border-gray-300 rounded-lg p-2 w-full mt-1 focus:ring-2 focus:ring-blue-500 focus:outline-none">
          <option value="all" {% if vehicle_type == 'all' %}selected{% endif %}>Tất cả</option>
          <option value="car" {% if vehicle_type == 'car' %}selected{% endif %}>Ô tô</option>
          <option value="motorcycle" {% if vehicle_type == 'motorcycle' %}selected{% endif %}>Xe máy</option>
          <option value="bike" {% if vehicle_type == 'bike' %}selected{% endif %}>Xe đạp</option>
        </select>
      </div>
      <div class="flex gap-2 items-end">
        <button type="submit" class="bg-blue-600 text-white rounded-lg px-4 py-2 font-semibold hover:bg-blue-700 transition shadow"><i class="fas fa-filter"></i> Lọc</button>
        <button type="button" id="exportButton" class="bg-green-500 text-white rounded-lg px-4 py-2 font-semibold hover:bg-green-600 transition shadow"><i class="fas fa-file-excel"></i> Xuất Excel</button>
      </div>
    </form>
  </div>

  <!-- Thống kê nhanh -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-gradient-to-br from-blue-500 to-blue-300 text-white rounded-xl shadow-lg p-6 flex flex-col items-center">
      <div class="text-3xl mb-2"><i class="fas fa-car"></i></div>
      <div class="text-lg">Ô tô</div>
      <div class="text-2xl font-bold" id="carCount">{{ car_count }}</div>
    </div>
    <div class="bg-gradient-to-br from-yellow-400 to-yellow-200 text-white rounded-xl shadow-lg p-6 flex flex-col items-center">
      <div class="text-3xl mb-2"><i class="fas fa-motorcycle"></i></div>
      <div class="text-lg">Xe máy</div>
      <div class="text-2xl font-bold" id="motorcycleCount">{{ motorcycle_count }}</div>
    </div>
    <div class="bg-gradient-to-br from-green-400 to-green-200 text-white rounded-xl shadow-lg p-6 flex flex-col items-center">
      <div class="text-3xl mb-2"><i class="fas fa-bicycle"></i></div>
      <div class="text-lg">Xe đạp</div>
      <div class="text-2xl font-bold" id="bikeCount">{{ bike_count }}</div>
    </div>
    <div class="bg-gradient-to-br from-pink-500 to-pink-300 text-white rounded-xl shadow-lg p-6 flex flex-col items-center">
      <div class="text-3xl mb-2"><i class="fas fa-coins"></i></div>
      <div class="text-lg">Doanh thu</div>
      <div class="text-2xl font-bold" id="totalRevenue">{{ total_revenue|floatformat:0|intcomma }} VNĐ</div>
    </div>
  </div>

  <!-- Bảng dữ liệu -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8 overflow-x-auto">
    <table id="parkingTable" class="w-full table-auto">
      <thead class="bg-blue-700 text-black font-extrabold border-b-4 border-blue-900">
        <tr>
          <th class="px-4 py-2">STT</th>
          <th class="px-4 py-2">Ngày</th>
          <th class="px-4 py-2">Biển số xe</th>
          <th class="px-4 py-2">Loại xe</th>
          <th class="px-4 py-2">Giờ vào</th>
          <th class="px-4 py-2">Giờ ra</th>
          <th class="px-4 py-2">Thời gian giữ</th>
          <th class="px-4 py-2">Phí (VNĐ)</th>
        </tr>
      </thead>
      <tbody>
        {% for record in parking_records %}
        <tr class="hover:bg-gray-50">
          <td class="border px-4 py-2">{{ forloop.counter }}</td>
          <td class="border px-4 py-2">{{ record.thoigianvao|date:"d/m/Y" }}</td>
          <td class="border px-4 py-2">{{ record.bienso.bienso }}</td>
          <td class="border px-4 py-2">{{ record.bienso.loaixe }}</td>
          <td class="border px-4 py-2">{{ record.thoigianvao|time:"H:i" }}</td>
          <td class="border px-4 py-2">{% if record.thoigianra %}{{ record.thoigianra|time:"H:i" }}{% else %}Chưa ra{% endif %}</td>
          <td class="border px-4 py-2">
            {% if record.thoigianra %}
              {{ record.thoigianvao|calculate_duration:record.thoigianra }}
            {% else %}
              Đang đỗ
            {% endif %}
          </td>
          <td class="border px-4 py-2">
            {% if record.thoigianra %}
              {% with duration=record.thoigianra|timeuntil:record.thoigianvao %}
                {% with hours=duration.total_seconds|div:3600 %}
                  {% with price=record.bienso.loaixe.giave.giatheogio %}
                    {{ price|mul:hours|floatformat:0|intcomma }}
                  {% endwith %}
                {% endwith %}
              {% endwith %}
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center text-gray-400 py-8">Không có dữ liệu phù hợp.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Biểu đồ -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <h3 class="text-lg font-semibold text-gray-700 mb-4">Biểu đồ thống kê số lượt xe</h3>
    <canvas id="vehicleChart" width="400" height="400"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Export to Excel
  document.getElementById('exportButton').addEventListener('click', function() {
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    const vehicleType = document.getElementById('vehicleType').value;
    let exportUrl = "{% url 'export_vehicle_report' %}?";
    if (fromDate) exportUrl += `from_date=${fromDate}&`;
    if (toDate) exportUrl += `to_date=${toDate}&`;
    if (vehicleType !== 'all') exportUrl += `vehicle_type=${vehicleType}`;
    window.location.href = exportUrl;
  });

  // Chart.js for vehicle statistics
  document.addEventListener('DOMContentLoaded', function () {
    const carCount = parseInt(document.getElementById('carCount').innerText) || 0;
    const motorcycleCount = parseInt(document.getElementById('motorcycleCount').innerText) || 0;
    const bikeCount = parseInt(document.getElementById('bikeCount').innerText) || 0;

    const ctx = document.getElementById('vehicleChart').getContext('2d');
    const vehicleChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Ô tô', 'Xe máy', 'Xe đạp'],
        datasets: [{
          label: 'Số lượng xe',
          data: [carCount, motorcycleCount, bikeCount],
          backgroundColor: [
            'rgba(59, 130, 246, 0.7)',
            'rgba(251, 191, 36, 0.7)',
            'rgba(34, 197, 94, 0.7)'
          ],
          borderColor: [
            'rgba(59, 130, 246, 1)',
            'rgba(251, 191, 36, 1)',
            'rgba(34, 197, 94, 1)'
          ],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
          },
          title: {
            display: false
          }
        }
      }
    });
  });
</script>
{% endblock contents %}